<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GHOST_PROTOCOL // DUCHENNE_V6</title>
    <style>
        /* --- CORE CYBERPUNK STYLING --- */
        body {
            margin: 0;
            background-color: #000;
            color: #0f0;
            font-family: 'Consolas', 'Monaco', monospace;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .surveillance-container {
            position: relative;
            width: 1280px;
            height: 720px;
            border: 1px solid #1a1a1a;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.15);
            background: #000;
        }

        .input_video { display: none; }

        .output_canvas {
            position: absolute;
            left: 0; top: 0; width: 100%; height: 100%;
            filter: contrast(1.1) brightness(1.1) sepia(1) hue-rotate(60deg) saturate(1.5);
        }

        .hud-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
        }

        .scanlines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.3),
                rgba(0, 0, 0, 0.3) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none; z-index: 20; opacity: 0.5;
        }

        /* --- PANELS --- */
        .panel {
            background: rgba(0, 15, 0, 0.9);
            border: 1px solid #004400;
            padding: 8px;
            position: absolute;
            font-size: 10px;
            backdrop-filter: blur(4px);
        }

        h2 {
            margin: 0 0 6px 0; padding-bottom: 2px;
            font-size: 11px; letter-spacing: 1px;
            border-bottom: 1px solid #00ff00;
            color: #ccffcc; text-transform: uppercase;
        }

        .row { display: flex; justify-content: space-between; margin-bottom: 2px; align-items: center; }
        .lbl { color: #5a8; }
        .val { color: #0f0; font-weight: 700; font-family: monospace; }
        .coord { color: #0ff; font-size: 9px; }

        /* --- LAYOUT POSITIONS --- */
        .p-coord-list { top: 20px; left: 20px; width: 220px; height: 280px; overflow-y: auto; }
        .p-calibration { bottom: 20px; left: 20px; width: 300px; height: 220px; pointer-events: auto; }
        .p-analysis { top: 20px; right: 20px; width: 280px; }
        .p-output { bottom: 20px; right: 20px; width: 280px; }

        /* --- ASSESSMENT PANEL --- */
        .p-assessment { 
            top: 20px; 
            left: 260px; 
            width: 320px; 
            pointer-events: auto;
            z-index: 30;
        }

        /* --- SLIDERS --- */
        input[type=range] {
            -webkit-appearance: none; width: 100px; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 10px; width: 10px;
            background: #0f0; cursor: pointer; border: 1px solid #fff; margin-top: -3px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #003300; border: 1px solid #005500;
        }

        /* --- BARS --- */
        .meter-container {
            height: 12px; background: #001100;
            margin-bottom: 4px; border: 1px solid #003300;
            position: relative;
        }
        .meter-fill {
            height: 100%; width: 0%; transition: width 0.1s;
        }
        .meter-text {
            position: absolute; top: 0; left: 4px;
            font-size: 9px; line-height: 12px; color: #fff; text-shadow: 1px 1px 0 #000;
        }

        #loading {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #000; border: 1px solid #0f0;
            padding: 20px; z-index: 100;
        }

        .duchenne-active {
            color: #fff; background: #0f0; padding: 2px 4px; border-radius: 2px;
            animation: pulse 0.5s infinite;
        }
        @keyframes pulse { 0% {opacity:1;} 50% {opacity:0.5;} 100% {opacity:1;} }

        /* --- ASSESSMENT STYLES --- */
        .btn-assess {
            background: linear-gradient(180deg, #003300, #001100);
            color: #0f0;
            border: 1px solid #0f0;
            padding: 8px 16px;
            cursor: pointer;
            font-family: 'Consolas', monospace;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s;
            width: 100%;
            margin-bottom: 8px;
        }
        .btn-assess:hover {
            background: linear-gradient(180deg, #004400, #002200);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        .btn-assess:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-assess.running {
            background: linear-gradient(180deg, #0f0, #080);
            color: #000;
            animation: pulse 0.5s infinite;
        }

        .api-input {
            width: calc(100% - 12px);
            background: #001100;
            border: 1px solid #003300;
            color: #0f0;
            padding: 5px;
            font-family: 'Consolas', monospace;
            font-size: 10px;
            margin-bottom: 8px;
        }
        .api-input:focus {
            outline: none;
            border-color: #0f0;
        }

        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .toggle-switch {
            position: relative;
            width: 40px;
            height: 20px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #003300;
            transition: 0.3s;
            border: 1px solid #005500;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 2px;
            bottom: 2px;
            background-color: #0f0;
            transition: 0.3s;
        }
        input:checked + .toggle-slider {
            background-color: #0f0;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
            background-color: #000;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #001100;
            border: 1px solid #003300;
            margin-bottom: 10px;
            display: none;
        }
        .progress-fill {
            height: 100%;
            background: #0f0;
            width: 0%;
            transition: width 0.1s linear;
        }

        .assessment-results {
            display: none;
            max-height: 300px;
            overflow-y: auto;
        }
        .result-section {
            border-top: 1px dashed #003300;
            padding-top: 8px;
            margin-top: 8px;
        }
        .result-header {
            color: #0ff;
            font-size: 10px;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        .result-value {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 3px;
        }
        .result-sub {
            font-size: 9px;
            color: #888;
        }
        .emotion-bar-mini {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
        }
        .emotion-bar-mini .label {
            width: 60px;
            font-size: 9px;
            color: #5a8;
        }
        .emotion-bar-mini .bar {
            flex: 1;
            height: 8px;
            background: #001100;
            border: 1px solid #003300;
            margin: 0 5px;
        }
        .emotion-bar-mini .bar-fill {
            height: 100%;
            transition: width 0.3s;
        }
        .emotion-bar-mini .value {
            width: 40px;
            font-size: 9px;
            color: #0f0;
            text-align: right;
        }

        .mistral-insight {
            background: rgba(0, 50, 50, 0.5);
            border: 1px solid #0ff;
            padding: 8px;
            margin-top: 10px;
            font-size: 9px;
            color: #0ff;
            line-height: 1.4;
        }
        .mistral-insight .title {
            color: #fff;
            font-size: 10px;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .export-btn {
            background: transparent;
            border: 1px solid #0ff;
            color: #0ff;
            padding: 5px 10px;
            cursor: pointer;
            font-family: 'Consolas', monospace;
            font-size: 9px;
            margin-top: 10px;
        }
        .export-btn:hover {
            background: rgba(0, 255, 255, 0.1);
        }
    </style>

    <!-- MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
</head>
<body>

<div class="surveillance-container">
    <div id="loading">INITIALIZING DUCHENNE ALGORITHMS...</div>

    <video class="input_video"></video>
    <canvas class="output_canvas" width="1280" height="720"></canvas>
    <div class="scanlines"></div>

    <div class="hud-layer">

        <!-- PANEL 1: 12-POINT TRACKING COORDINATES -->
        <div class="panel p-coord-list">
            <h2>TARGET VECTORS (XYZ)</h2>
            <div id="coord-list-content"></div>
        </div>

        <!-- PANEL: ASSESSMENT CONTROLS -->
        <div class="panel p-assessment">
            <h2>EMOTIONAL ASSESSMENT</h2>
            
            <div class="toggle-row">
                <span class="lbl">MISTRAL AI ENHANCEMENT</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="mistral-toggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <input type="password" class="api-input" id="mistral-api" placeholder="MISTRAL API KEY (OPTIONAL)">
            
            <button class="btn-assess" id="btn-start-assess">
                â–¶ START ASSESSMENT (5s)
            </button>
            
            <div class="progress-bar" id="assess-progress">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            
            <div id="assess-status" style="font-size:9px; color:#888; text-align:center;"></div>

            <div class="assessment-results" id="assessment-results">
                <div class="result-section">
                    <div class="result-header">DOMINANT EMOTION</div>
                    <div class="result-value" id="res-dominant">--</div>
                    <div class="result-sub" id="res-confidence">Confidence: --</div>
                </div>

                <div class="result-section">
                    <div class="result-header">EMOTIONAL BREAKDOWN</div>
                    <div id="emotion-breakdown"></div>
                </div>

                <div class="result-section">
                    <div class="result-header">STABILITY SCORE</div>
                    <div class="result-value" id="res-stability">--</div>
                    <div class="result-sub">Lower variance = higher stability</div>
                </div>

                <div class="result-section" id="mistral-section" style="display:none;">
                    <div class="mistral-insight">
                        <div class="title">ðŸ¤– MISTRAL AI INSIGHT</div>
                        <div id="mistral-insight-text">--</div>
                    </div>
                </div>

                <button class="export-btn" onclick="exportAssessment()">ðŸ“¥ EXPORT JSON</button>
            </div>
        </div>

        <!-- PANEL 2: ALGORITHMIC CALIBRATION -->
        <div class="panel p-calibration">
            <h2>SENSITIVITY MATRIX</h2>
            <div style="font-size:9px; color:#888; margin-bottom:5px;">ADJUST WEIGHTS TO BIAS DETECTION</div>

            <div class="row"><span class="lbl">JOY_WEIGHT</span><input type="range" id="w-joy" min="0" max="3" step="0.1" value="1"><span class="val" id="v-joy">1.0</span></div>
            <div class="row"><span class="lbl">ANGER_WEIGHT</span><input type="range" id="w-anger" min="0" max="3" step="0.1" value="1"><span class="val" id="v-anger">1.0</span></div>
            <div class="row"><span class="lbl">SADNESS_WEIGHT</span><input type="range" id="w-sad" min="0" max="3" step="0.1" value="1"><span class="val" id="v-sad">1.0</span></div>
            <div class="row"><span class="lbl">FEAR_WEIGHT</span><input type="range" id="w-fear" min="0" max="3" step="0.1" value="1"><span class="val" id="v-fear">1.0</span></div>
            <div class="row"><span class="lbl">DISGUST_WEIGHT</span><input type="range" id="w-disgust" min="0" max="3" step="0.1" value="1"><span class="val" id="v-disgust">1.0</span></div>
            <div class="row"><span class="lbl">CONTEMPT_WEIGHT</span><input type="range" id="w-contempt" min="0" max="3" step="0.1" value="1"><span class="val" id="v-contempt">1.0</span></div>
            <div style="margin-top:10px; border-top:1px dashed #0f0; padding-top:5px; text-align:center;">
                <button onclick="resetWeights()" style="background:#003300; color:#0f0; border:1px solid #0f0; cursor:pointer;">RESET BASELINE</button>
            </div>
        </div>

        <!-- PANEL 3: MORPHOMETRIC ANALYSIS -->
        <div class="panel p-analysis">
            <h2>MORPHOMETRICS</h2>
            <div class="row"><span class="lbl">SMILE_VEC (Joy):</span><span class="val" id="m-smile">0.00</span></div>
            <div class="row"><span class="lbl">EYE_SQUINT (Joy++):</span><span class="val" id="m-squint">0.00</span></div>
            <div class="row"><span class="lbl">BROW_COMPRESS (Anger):</span><span class="val" id="m-brow">0.00</span></div>
            <div class="row"><span class="lbl">NOSE_WRINKLE (Disgust):</span><span class="val" id="m-nose">0.00</span></div>
            <div class="row"><span class="lbl">EYE_WIDE (Fear):</span><span class="val" id="m-eye">0.00</span></div>
            <div class="row"><span class="lbl">ASYMMETRY (Contempt):</span><span class="val" id="m-asy">0.00</span></div>

            <div id="duchenne-status" style="margin-top:5px; text-align:center; font-size:9px; color:#555;">DUCHENNE MARKER: INACTIVE</div>
        </div>

        <!-- PANEL 4: FINAL OUTPUT -->
        <div class="panel p-output">
            <h2>EMOTIONAL PROFILE</h2>
            <div style="text-align:center; margin-bottom:10px;">
                <span id="dom-emo" style="font-size:24px; font-weight:bold; color:#fff;">SCANNING</span>
                <br>
                <span id="dom-conf" style="color:#0f0; font-size:10px;">CONFIDENCE: 0.0%</span>
            </div>

            <div class="meter-container"><div class="meter-fill" id="bar-joy" style="background:#0f0"></div><span class="meter-text">JOY</span></div>
            <div class="meter-container"><div class="meter-fill" id="bar-anger" style="background:#f00"></div><span class="meter-text">ANGER</span></div>
            <div class="meter-container"><div class="meter-fill" id="bar-sad" style="background:#00f"></div><span class="meter-text">SADNESS</span></div>
            <div class="meter-container"><div class="meter-fill" id="bar-fear" style="background:#ff0"></div><span class="meter-text">FEAR</span></div>
            <div class="meter-container"><div class="meter-fill" id="bar-disgust" style="background:#f0f"></div><span class="meter-text">DISGUST</span></div>
            <div class="meter-container"><div class="meter-fill" id="bar-contempt" style="background:#0ff"></div><span class="meter-text">CONTEMPT</span></div>
        </div>

    </div>
</div>

<script>
    const videoElement = document.getElementsByClassName('input_video')[0];
    const canvasElement = document.getElementsByClassName('output_canvas')[0];
    const ctx = canvasElement.getContext('2d');
    const loadingDiv = document.getElementById('loading');

    // --- CONFIGURATION ---
    const TRACKED_POINTS = [
        {id: 1, name: "NOSE_TIP"},
        {id: 168, name: "GLABELLA"},
        {id: 152, name: "CHIN_TIP"},
        {id: 33, name: "L_EYE_OUT"},
        {id: 263, name: "R_EYE_OUT"},
        {id: 61, name: "MOUTH_L"},
        {id: 291, name: "MOUTH_R"},
        {id: 13, name: "UPPER_LIP"},
        {id: 14, name: "LOWER_LIP"},
        {id: 105, name: "L_BROW"},
        {id: 334, name: "R_BROW"},
        {id: 234, name: "L_CHEEK"},
        {id: 454, name: "R_CHEEK"}
    ];

    const EMOTION_COLORS = {
        joy: '#0f0',
        anger: '#f00',
        sadness: '#00f',
        fear: '#ff0',
        disgust: '#f0f',
        contempt: '#0ff'
    };

    // --- STATE ---
    let weights = {
        joy: 1.0, anger: 1.0, sadness: 1.0, 
        fear: 1.0, disgust: 1.0, contempt: 1.0
    };

    // --- ASSESSMENT STATE ---
    let isAssessing = false;
    let assessmentData = [];
    let assessmentStartTime = null;
    let assessmentDuration = 5000; // 5 seconds
    let lastAssessmentResult = null;
    let capturedFrames = [];

    // --- LOAD SAVED API KEY ---
    const savedApiKey = localStorage.getItem('mistral_api_key');
    if (savedApiKey) {
        document.getElementById('mistral-api').value = savedApiKey;
    }

    // --- INITIALIZE UI ---
    const coordList = document.getElementById('coord-list-content');
    TRACKED_POINTS.forEach(p => {
        const div = document.createElement('div');
        div.className = 'row';
        div.innerHTML = `<span class="lbl">${p.name}</span><span class="coord" id="coord-${p.id}">0.00, 0.00, 0.00</span>`;
        coordList.appendChild(div);
    });

    document.querySelectorAll('input[type=range]').forEach(input => {
        input.addEventListener('input', (e) => {
            const type = e.target.id.split('-')[1];
            weights[type] = parseFloat(e.target.value);
            document.getElementById(`v-${type}`).innerText = weights[type].toFixed(1);
        });
    });

    // Save API key on change
    document.getElementById('mistral-api').addEventListener('change', (e) => {
        localStorage.setItem('mistral_api_key', e.target.value);
    });

    function resetWeights() {
        Object.keys(weights).forEach(k => {
            weights[k] = 1.0;
            document.getElementById(`w-${k}`).value = 1.0;
            document.getElementById(`v-${k}`).innerText = "1.0";
        });
    }

    // --- ASSESSMENT CONTROLS ---
    document.getElementById('btn-start-assess').addEventListener('click', startAssessment);

    async function startAssessment() {
        if (isAssessing) return;

        isAssessing = true;
        assessmentData = [];
        capturedFrames = [];
        assessmentStartTime = Date.now();

        const btn = document.getElementById('btn-start-assess');
        const progressBar = document.getElementById('assess-progress');
        const progressFill = document.getElementById('progress-fill');
        const status = document.getElementById('assess-status');
        const results = document.getElementById('assessment-results');

        btn.classList.add('running');
        btn.textContent = 'â—‰ SCANNING...';
        btn.disabled = true;
        progressBar.style.display = 'block';
        results.style.display = 'none';
        status.textContent = 'Capturing emotional data...';

        // Progress update loop
        const progressInterval = setInterval(() => {
            const elapsed = Date.now() - assessmentStartTime;
            const progress = Math.min((elapsed / assessmentDuration) * 100, 100);
            progressFill.style.width = progress + '%';

            if (elapsed >= assessmentDuration) {
                clearInterval(progressInterval);
                finishAssessment();
            }
        }, 50);
    }

    async function finishAssessment() {
        isAssessing = false;

        const btn = document.getElementById('btn-start-assess');
        const progressBar = document.getElementById('assess-progress');
        const status = document.getElementById('assess-status');
        const results = document.getElementById('assessment-results');

        btn.classList.remove('running');
        btn.textContent = 'â–¶ START ASSESSMENT (5s)';
        btn.disabled = false;
        progressBar.style.display = 'none';
        status.textContent = 'Processing results...';

        // Calculate MediaPipe results
        const mediapipeResults = calculateAssessmentResults();

        // Check if Mistral is enabled
        const useMistral = document.getElementById('mistral-toggle').checked;
        const apiKey = document.getElementById('mistral-api').value;

        let mistralResults = null;
        if (useMistral && apiKey && capturedFrames.length > 0) {
            status.textContent = 'Querying Mistral AI...';
            mistralResults = await getMistralAnalysis(apiKey, capturedFrames[Math.floor(capturedFrames.length / 2)]);
        }

        // Display results
        displayAssessmentResults(mediapipeResults, mistralResults);
        results.style.display = 'block';
        status.textContent = 'Assessment complete';

        lastAssessmentResult = {
            timestamp: new Date().toISOString(),
            duration: assessmentDuration,
            samples: assessmentData.length,
            mediapipe: mediapipeResults,
            mistral: mistralResults
        };
    }

    function calculateAssessmentResults() {
        if (assessmentData.length === 0) {
            return { dominant: 'neutral', confidence: 0, emotions: {}, stability: 0 };
        }

        // Calculate averages
        const emotions = ['joy', 'anger', 'sadness', 'fear', 'disgust', 'contempt'];
        const averages = {};
        const peaks = {};
        const variances = {};

        emotions.forEach(e => {
            const values = assessmentData.map(d => d.emotions[e]);
            averages[e] = values.reduce((a, b) => a + b, 0) / values.length;
            peaks[e] = Math.max(...values);
            
            const mean = averages[e];
            variances[e] = values.reduce((sum, v) => sum + Math.pow(v - mean, 2), 0) / values.length;
        });

        // Find dominant emotion
        const dominant = Object.keys(averages).reduce((a, b) => averages[a] > averages[b] ? a : b);
        const confidence = averages[dominant];

        // Calculate stability (inverse of total variance)
        const totalVariance = Object.values(variances).reduce((a, b) => a + b, 0);
        const stability = Math.max(0, 100 - totalVariance);

        // Duchenne detection rate
        const duchenneCount = assessmentData.filter(d => d.metrics.isDuchenne).length;
        const duchenneRate = (duchenneCount / assessmentData.length) * 100;

        return {
            dominant,
            confidence,
            emotions: averages,
            peaks,
            variances,
            stability,
            duchenneRate,
            sampleCount: assessmentData.length
        };
    }

    async function getMistralAnalysis(apiKey, imageDataUrl) {
        try {
            const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: "pixtral-12b-2409",
                    messages: [{
                        role: "user",
                        content: [
                            {
                                type: "image_url",
                                image_url: { url: imageDataUrl }
                            },
                            {
                                type: "text",
                                text: `Analyze this person's emotional state from their facial expression. Provide:
1. Primary emotion detected (joy, anger, sadness, fear, disgust, contempt, surprise, neutral)
2. Confidence level (0-100)
3. Secondary emotions if present
4. Whether the expression appears genuine or posed
5. Any notable micro-expressions or subtle cues
6. A brief psychological insight (1-2 sentences)

Respond in JSON format:
{"primary_emotion": "", "confidence": 0, "secondary_emotions": [], "is_genuine": true, "micro_expressions": [], "insight": ""}`
                            }
                        ]
                    }],
                    max_tokens: 300
                })
            });

            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }

            const data = await response.json();
            const content = data.choices[0].message.content;
            
            // Try to parse JSON from response
            const jsonMatch = content.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                return JSON.parse(jsonMatch[0]);
            }
            return { error: 'Could not parse response', raw: content };
        } catch (error) {
            console.error('Mistral API error:', error);
            return { error: error.message };
        }
    }

    function displayAssessmentResults(mp, mistral) {
        // Dominant emotion
        document.getElementById('res-dominant').textContent = mp.dominant.toUpperCase();
        document.getElementById('res-dominant').style.color = EMOTION_COLORS[mp.dominant] || '#fff';
        document.getElementById('res-confidence').textContent = `Confidence: ${mp.confidence.toFixed(1)}% | Samples: ${mp.sampleCount}`;

        // Emotion breakdown
        const breakdownEl = document.getElementById('emotion-breakdown');
        breakdownEl.innerHTML = '';
        
        Object.entries(mp.emotions).forEach(([emotion, value]) => {
            const row = document.createElement('div');
            row.className = 'emotion-bar-mini';
            row.innerHTML = `
                <span class="label">${emotion.toUpperCase()}</span>
                <div class="bar"><div class="bar-fill" style="width:${value}%; background:${EMOTION_COLORS[emotion]}"></div></div>
                <span class="value">${value.toFixed(1)}%</span>
            `;
            breakdownEl.appendChild(row);
        });

        // Stability
        document.getElementById('res-stability').textContent = mp.stability.toFixed(1) + '%';
        document.getElementById('res-stability').style.color = mp.stability > 70 ? '#0f0' : mp.stability > 40 ? '#ff0' : '#f00';

        // Mistral insights
        const mistralSection = document.getElementById('mistral-section');
        if (mistral && !mistral.error) {
            mistralSection.style.display = 'block';
            document.getElementById('mistral-insight-text').innerHTML = `
                <strong>${mistral.primary_emotion?.toUpperCase() || 'N/A'}</strong> (${mistral.confidence || 0}% conf)<br>
                ${mistral.is_genuine ? 'âœ“ Genuine expression' : 'âš  May be posed'}<br>
                ${mistral.micro_expressions?.length ? `Micro: ${mistral.micro_expressions.join(', ')}` : ''}<br>
                <em>${mistral.insight || ''}</em>
            `;
        } else if (mistral?.error) {
            mistralSection.style.display = 'block';
            document.getElementById('mistral-insight-text').textContent = `Error: ${mistral.error}`;
        } else {
            mistralSection.style.display = 'none';
        }
    }

    function exportAssessment() {
        if (!lastAssessmentResult) return;

        const blob = new Blob([JSON.stringify(lastAssessmentResult, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `emotion_assessment_${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // --- FACS ENGINE (LOGIC CORE) ---
    class FacsEngine {
        analyze(lm) {
            // Normalize based on Face Height (168 to 152)
            const vScale = Math.hypot(lm[168].x - lm[152].x, lm[168].y - lm[152].y);
            const getDist = (i1, i2) => Math.hypot(lm[i1].x - lm[i2].x, lm[i1].y - lm[i2].y) / vScale;

            // --- METRICS ---

            // 1. SMILE VECTOR (Joy)
            const mouthCenterY = (lm[13].y + lm[14].y) / 2;
            const cornersY = (lm[61].y + lm[291].y) / 2;
            const smileVector = (mouthCenterY - cornersY) / vScale;

            // 2. EYE OPENNESS (Squint vs Wide)
            const eyeOpen = (getDist(159, 145) + getDist(386, 374)) / 2;

            // 3. ANGER (Glabella Compression)
            const glabella = getDist(66, 296);

            // 4. DISGUST (Nose Wrinkle)
            const noseWrinkle = getDist(6, 10);

            // 5. ASYMMETRY (Contempt)
            const skew = Math.abs(lm[61].y - lm[291].y) / vScale;

            // --- SCORING ---
            let s = { joy:0, anger:0, disgust:0, sadness:0, fear:0, contempt:0 };
            let isDuchenne = false;

            // JOY LOGIC:
            if (smileVector > -0.01) { 
                s.joy += (smileVector + 0.01) * 800 * weights.joy;
            }

            // DUCHENNE BOOST (Squint + Smile)
            if (smileVector > 0.02 && eyeOpen < 0.055) {
                s.joy += (0.055 - eyeOpen) * 3000 * weights.joy;
                isDuchenne = true;
            }

            // ANGER LOGIC
            if(glabella < 0.15) s.anger += (0.15 - glabella) * 500 * weights.anger;

            // DISGUST LOGIC
            if(noseWrinkle < 0.45) s.disgust += (0.45 - noseWrinkle) * 400 * weights.disgust;

            // SADNESS LOGIC (Negative smile vector + Brow interaction)
            if(smileVector < -0.01) s.sadness += Math.abs(smileVector) * 800 * weights.sadness;

            // FEAR LOGIC (Wide Eyes)
            if(eyeOpen > 0.09) s.fear += (eyeOpen - 0.09) * 600 * weights.fear;

            // CONTEMPT (Asymmetry check)
            if(skew > 0.02 && s.joy < 20) s.contempt += skew * 1000 * weights.contempt;

            // Normalize
            const total = Object.values(s).reduce((a,b)=>a+b,0) + 10;
            const emotions = {};
            for(let k in s) emotions[k] = (s[k]/total)*100;

            return {
                metrics: { smileVector, eyeOpen, glabella, noseWrinkle, skew, isDuchenne },
                emotions
            };
        }
    }

    const engine = new FacsEngine();

    // --- RENDER LOOP ---
    const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
    faceMesh.setOptions({maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
    faceMesh.onResults(onResults);

    const camera = new Camera(videoElement, {
        onFrame: async () => { await faceMesh.send({image: videoElement}); },
        width: 1280, height: 720
    });

    function onResults(results) {
        const w = canvasElement.width;
        const h = canvasElement.height;

        ctx.save();
        ctx.clearRect(0, 0, w, h);

        // Mirror video
        ctx.translate(w, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(results.image, 0, 0, w, h);

        // Cyberpunk Filter Overlay
        ctx.fillStyle = 'rgba(0, 20, 0, 0.4)';
        ctx.fillRect(0,0,w,h);

        if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
            const lm = results.multiFaceLandmarks[0];
            const data = engine.analyze(lm);

            // 1. Draw Mesh (Faint)
            drawConnectors(ctx, lm, FACEMESH_TESSELATION, {color: '#003300', lineWidth: 0.5});

            // 2. Draw 12 Tracked Points
            TRACKED_POINTS.forEach(p => {
                const point = lm[p.id];
                const x = point.x * w;
                const y = point.y * h;

                ctx.strokeStyle = '#0f0';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.arc(x, y, 2, 0, 2*Math.PI);
                ctx.stroke();

                // Sniper Crosshair
                ctx.beginPath();
                ctx.moveTo(x-4, y); ctx.lineTo(x+4, y);
                ctx.moveTo(x, y-4); ctx.lineTo(x, y+4);
                ctx.stroke();

                const el = document.getElementById(`coord-${p.id}`);
                if(el) el.innerText = `${point.x.toFixed(2)}, ${point.y.toFixed(2)}, ${(point.z*10).toFixed(2)}`;
            });

            ctx.restore(); 

            updateUI(data);

            // Collect assessment data if running
            if (isAssessing) {
                assessmentData.push(data);
                
                // Capture frame for Mistral (every ~1 second)
                if (capturedFrames.length < 5 && assessmentData.length % 30 === 0) {
                    capturedFrames.push(canvasElement.toDataURL('image/jpeg', 0.7));
                }
            }

        } else {
            ctx.restore();
        }
        loadingDiv.style.display = 'none';
    }

    function updateUI(data) {
        const m = data.metrics;
        const e = data.emotions;

        // Update Morphometrics
        document.getElementById('m-smile').innerText = m.smileVector.toFixed(3);
        document.getElementById('m-squint').innerText = m.eyeOpen.toFixed(3);
        document.getElementById('m-brow').innerText = m.glabella.toFixed(3);
        document.getElementById('m-nose').innerText = m.noseWrinkle.toFixed(3);
        document.getElementById('m-eye').innerText = m.eyeOpen.toFixed(3);
        document.getElementById('m-asy').innerText = m.skew.toFixed(3);

        // Duchenne Indicator
        const dStat = document.getElementById('duchenne-status');
        if(m.isDuchenne) {
            dStat.innerText = "DUCHENNE MARKER: ACTIVE";
            dStat.className = "duchenne-active";
        } else {
            dStat.innerText = "DUCHENNE MARKER: INACTIVE";
            dStat.className = "";
        }

        // Update Emotion Bars
        setBar('joy', e.joy);
        setBar('anger', e.anger);
        setBar('sad', e.sadness);
        setBar('fear', e.fear);
        setBar('disgust', e.disgust);
        setBar('contempt', e.contempt);

        // Dominant
        let dom = Object.keys(e).reduce((a,b)=>e[a]>e[b]?a:b);
        let val = e[dom];
        let el = document.getElementById('dom-emo');

        if(val < 25) {
            el.innerText = "NEUTRAL";
            el.style.color = "#888";
        } else {
            el.innerText = dom.toUpperCase();
            if(dom === 'joy') el.style.color = '#0f0';
            if(dom === 'anger') el.style.color = '#f00';
            if(dom === 'sadness') el.style.color = '#00f';
            if(dom === 'fear') el.style.color = '#ff0';
            if(dom === 'disgust') el.style.color = '#f0f';
            if(dom === 'contempt') el.style.color = '#0ff';
        }
        document.getElementById('dom-conf').innerText = `CONFIDENCE: ${val.toFixed(1)}%`;
    }

    function setBar(id, val) {
        document.getElementById(`bar-${id}`).style.width = val + "%";
    }

    camera.start();
</script>
</body>
</html>
